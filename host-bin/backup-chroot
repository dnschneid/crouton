#!/bin/sh -e
# Copyright (c) 2013 The Chromium OS Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

set -e

# create the backup directory if not already created and
# create the gz compressed backup file in 
# /home/chronos/user/Downloads/crouton-backups/NAME/

usage="Description: This will create a gz compressed backup of the chroot.
The Default target is ~/Downloads/crouton-backups/name/
The Default file name will be name-yyyymmdd-hhmm.tar.gz

Usage: backup-chroot <options> name

Options:
	-t target   - This will set the target to something other than the default.
		      Do not add a trailing slash at the end of this parameter
	-f filename - This will change the filename, setting a pure"

default_target="/home/chronos/user/Downloads/crouton-backups"
date="`date '+%Y%m%d-%H%M'`"

if [ ! $1 = '' ]; then

	if [ "$2" = '' ]; then

		name="$1"
		target="$default_target/$name"
		filename=""$name"-"`date '+%Y%m%d-%H%M'`".tar.gz"

	elif [ "$1" = '-t' ] || [ "$1" = '-f' ] && [ ! "$2" = '' ] && [ ! "$3" = '' ]; then

		if [ "$1" = '-t' ] && [ "$4" = "" ]; then

			name="$3"
			target="$2"
			filename=""$name"-"`date '+%Y%m%d-%H%M'`".tar.gz"

		elif [ "$1" = '-f' ] && [ "$4" = "" ]; then

			name="$3"
			filename="$2"
			target="$default_target/$filename"
			filename="$filename-$date.tar.gz"

		fi
	fi
#	elif [ "$1" = '-t' ] || [ "$1" = '-f' ] && []
	
	mkdir -p "$target"
	# .gz compression is always on in this mode, for frequent backups
	# this will save a lot of space.
	edit-chroot -f "$target"/"$filename" -b "$name"

else

	echo "$usage"

fi
