#!/bin/sh -e
# Copyright (c) 2016 The crouton Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.
#
# Helper script for launching services normally managed by upstart.
# Called during session's XDG autostart.

RELEASE="`/usr/local/bin/croutonversion -r`"

# Function to run the exec line from an Upstart conf file.
# Assumes no spaces in the path and no arguments for simplicity.
execfromconf() {
    local exec_cmd="`awk '/^exec/{print $2; exit}' "$1"`"
    if [ -x "$exec_cmd" ]; then
        "$exec_cmd" &
    fi
}

# Unity handling for xenial and later releases.
if [ "$RELEASE" = 'xenial' ]; then
    # Start Unity if the executable exists.
    PATH="$PATH":/sbin
    if [ -x /usr/bin/unity ]; then
        /usr/bin/unity &
    fi

    # Start Unity-specific services for xenial.
    unity_services="unity-panel-service window-stack-bridge"
    for service in $unity_services; do
        conf_file=/usr/share/upstart/sessions/"$service".conf
        if [ -f "$conf_file" ]; then
            execfromconf "$conf_file"
        fi
    done
fi

# Generic handling for trusty and later releases.
if [ "$RELEASE" = 'trusty' -o "$RELEASE" = 'xenial' ]; then
    for conf_file in /usr/share/upstart/sessions/*.conf; do
        if grep -q '^start on.* indicator-services-start' "$conf_file"; then
            execfromconf "$conf_file"
        fi
    done
fi

# Backward compatibility for non-xenial releases.
if [ "$RELEASE" != 'precise' ]; then
    services="unity-panel-service window-stack-bridge"
    for service in $services; do
        conf_file=/usr/share/upstart/sessions/"$service".conf
        if [ -f "$conf_file" ]; then
            execfromconf "$conf_file"
        fi
    done
fi
