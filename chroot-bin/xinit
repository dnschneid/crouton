#!/bin/sh -e
# Copyright (c) 2013 The Chromium OS Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

# Morphs the xinit command line to use the wrapper client, correct the X
# display, remove any auth reference, and default to the crouton xserverrc.
# By putting this in /usr/local/bin, PATH will prefer it and scripts that
# call xinit will automagically work.

xserverrc='/etc/X11/xinit/xserverrc'
dash='--'
disp=''
n=$#
while [ ! "$n" = 0 ]; do
    arg="$1"
    n="$((n-1))"
    shift
    if [ -z "$disp" -a ! "${arg#":"}" = "$arg" ]; then
        disp="$arg"
        continue
    elif [ "$arg" = '-auth' ]; then
        if [ ! "$n" = 0 ]; then
            n="$((n-1))"
            shift
        fi
        continue
    elif [ -n "$dash" -a "$arg" = '--' ]; then
        dash=
        # Check if there's a xserverrc specified.
        if [ ! "${1#/}" = "$1" ]; then
            xserverrc=''
        fi
    fi
    set -- "$@" "$arg"
done

disp=0
while [ -f "/tmp/.X$disp-lock" ]; do
    disp=$((disp+1))
done

exec /usr/bin/xinit /usr/local/bin/croutonxinitrc-wrapper "$@" $dash $xserverrc ":$disp"
