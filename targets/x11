#!/bin/sh -e
# Copyright (c) 2013 The Chromium OS Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.
if [ ! "$TARGETS" = 'help' -a ! "${ARCH#arm}" = "$ARCH" ]; then
    echo 'x11 target does not work on ARM. Substituting in xephyr.' 1>&2
    TARGET=xephyr
    . "${TARGETSDIR:="$PWD"}/$TARGET"
fi
# This is not a good way to update the overlay, but I can't think of
# an alternative to clobbering it on each re-run of the X11 target.
# Overlays are usually updated using either rsync or git.
if [ "${DISTROAKA:-"$DISTRO"}" = 'gentoo' ]; then
    rm -r $CHROOT/usr/local/portage/crouton-overlay
    mkdir -p $CHROOT/usr/local/portage/crouton-overlay
    cp -RL $INSTALLERDIR/$DISTRO/crouton-overlay/$RELEASE/* $CHROOT/usr/local/portage/crouton-overlay
    mkdir -p $CHROOT/etc/portage/package.accept_keywords
    echo "x11-libs/geis ~$ARCH\nx11-libs/frame ~$ARCH\nx11-libs/evemu ~$ARCH\
        \nx11-libs/grail ~$ARCH\nx11-misc/touchegg ~$ARCH\nx11-misc/xprintidle ~$ARCH" \
        > $CHROOT/etc/portage/package.accept_keywords/crouton-overlay
fi
REQUIRES='core'
DESCRIPTION='Basic X11 install. Does not install any desktop environment.'
CHROOTBIN='croutoncycle croutonpowerd croutonxinitrc-wrapper setres xinit'
CHROOTETC='xbindkeysrc.scm xserverrc-x11'
. "${TARGETSDIR:="$PWD"}/common"

### Append to prepare.sh:
XMETHOD=x11

# xorg doesn't build a video driver by default, is there some way to automatically detect it?
if [ "${DISTROAKA:-"$DISTRO"}" = 'gentoo' ]; then
# Set desktop profile
    PROFILE_ACTION="set"
    if [ $RELEASE = "funtoo" ]; then
        PROFILE_ACTION="set-flavor"
    fi
    GENTOO_PROFILE=$"`eselect profile list | grep desktop | grep -P -o '(?<=\[)[0-9]*(?=\])' | head -n 1`"
    if [ -n $GENTOO_PROFILE ]; then
        eselect profile "$PROFILE_ACTION" "$GENTOO_PROFILE"
    fi
    if ! `/bin/grep -q 'VIDEO_CARDS' /etc/portage/make.conf`; then
#        echo -e "Your graphics hardware is reported as:  `/usr/sbin/lspci | grep -i vga` \r\nPlease select a corresponding driver:  "
#        read videodriver
        echo -e "VIDEO_CARDS=\"intel fbdev\"" >> /etc/portage/make.conf
    fi
# Do we need to compile the synaptics touchpad driver?  Gentoo seems to not include this by default
    if ! `/bin/grep -q 'INPUT_DEVICES' /etc/portage/make.conf`; then
        echo -e "INPUT_DEVICES=\"evdev keyboard mouse synaptics\"" >> /etc/portage/make.conf
    fi
fi

# The xorg-server package is fairly minimal, Gentoo usually recommends installing
# a much larger xorg-x11 package

install gentoo=xorg-server,xorg gentoo=,dmz-cursor-theme gentoo=,kbd

# Fix launching X11 from inside crosh (user doesn't own a TTY)
if [ "${DISTROAKA:-"$DISTRO"}" = 'debian' ]; then
	sed -i 's/allowed_users=.*/allowed_users=anybody/' '/etc/X11/Xwrapper.config'
fi

# Make chvt and fgconsole SUID root so we don't need to run keylaunch as root

chmod u+s `which chvt` `which fgconsole`

TIPS="$TIPS
You can flip through your running chroot desktops and Chromium OS by hitting
Ctrl+Alt+Shift+Back and Ctrl+Alt+Shift+Forward.
"

### append x11-common
