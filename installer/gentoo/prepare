#!/bin/sh -e
# Copyright (c) 2013 The Chromium OS Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

# This is a distro-specific continuation of the prepare.sh script.

#PKGEXT='deb'
DISTROAKA='gentoo'
NJOBS=$((`grep -c '^processor' /proc/cpuinfo`+1))

# install_dist: see install() in prepare.sh for details.
install_dist() {
    local pkgs='' params=''
    if [ "$1" = '--minimal' ]; then
        params='--oneshot'
        shift
    fi
    while [ ! "$#" = 0 ]; do
        if [ "$1" = '--' ]; then
            shift
            break
        fi
        pkgs="$pkgs $1"
        shift
    done
#    emerge --autounmask-write --newuse -qu --jobs=$NJOBS $params $pkgs  
#    dispatch-conf
    emerge --newuse -qu --jobs=$NJOBS $params $pkgs 
}


# install_pkg_dist: see install_pkg() in prepare.sh for details.
install_pkg_dist() {
    error 1 'ERROR: install_pkg_dist does not make sense for Gentoo'
}


# remove_dist: see remove() in prepare.sh for details.
remove_dist() {
    emerge -C "$@"
    emerge --depclean
    revdep-rebuild
}


# list_uninstalled_dist: see list_uninstalled() in prepare.sh for details.
#I'm not sure this make sense for Gentoo
list_uninstalled_dist() {
    for pkg in "$@"; do
        if ! `genlop -i "$pkg" | grep -q "date"` 2>/dev/null; then
            echo -n "$pkg "
        fi
    done
}
# Bootstrap portage
emerge --sync
#Set MAKEOPTS and jobs based on processor cores
if ! grep -q 'MAKEOPTS' '/etc/portage/make.conf' 2>/dev/null; then
    echo "MAKEOPTS=\"-j$NJOBS\"" >> /etc/portage/make.conf
fi

# Update portage
install --minimal portage

# Fix the keyboard mode early on (this will be called again after dist-upgrade).
fixkeyboardmode
